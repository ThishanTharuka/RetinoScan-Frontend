<app-dashboard-layout>
  <!-- Main Content Area -->
  <div class="dashboard-content">
    <!-- Header Section -->
    <div class="page-header">
      <h1>Analysis History</h1>
      <p class="page-subtitle">
        Review past retinal scans and analysis results.
      </p>
    </div>

    <!-- Search and Actions Section -->
    <div class="controls-section">
      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Search by date or severity</mat-label>
          <input
            matInput
            placeholder="Search by date or severity"
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
            #searchInput
          />
          <mat-icon matPrefix>search</mat-icon>
          <button
            *ngIf="searchTerm"
            matSuffix
            mat-icon-button
            (click)="clearSearch()"
            aria-label="Clear search"
          >
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <div class="header-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="navigateToUpload()"
          class="upload-btn"
        >
          <mat-icon>add_photo_alternate</mat-icon>
          New Analysis
        </button>
        <button
          mat-icon-button
          (click)="refreshAnalyses()"
          matTooltip="Refresh"
          [disabled]="isLoading()"
        >
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-container">
      <mat-spinner></mat-spinner>
      <p>Loading your analysis history...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error() && !isLoading()" class="error-container">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="refreshAnalyses()">
        Try Again
      </button>
    </div>

    <!-- Empty State -->
    <div
      *ngIf="!isLoading() && !error() && analyses().length === 0"
      class="empty-state"
    >
      <mat-icon>image_search</mat-icon>
      <h2>No analyses yet</h2>
      <p>Start by uploading your first retinal image for analysis</p>
      <button mat-raised-button color="primary" (click)="navigateToUpload()">
        <mat-icon>add_photo_alternate</mat-icon>
        Upload Image
      </button>
    </div>

    <!-- Analysis Table -->
    <div
      *ngIf="!isLoading() && !error() && filteredAnalyses().length > 0"
      class="table-container"
    >
      <div class="analysis-table">
        <!-- Table Header -->
        <div class="table-header">
          <div class="header-cell date-column">Date/Time</div>
          <div class="header-cell severity-column">Severity</div>
          <div class="header-cell image-column">Retina Image</div>
          <div class="header-cell actions-column">Actions</div>
        </div>

        <!-- Table Rows -->
        <div class="table-body">
          <button
            *ngFor="let analysis of filteredAnalyses()"
            class="table-row"
            [class]="getSeverityClass(analysis.prediction?.severity_level)"
            (click)="viewAnalysisDetails(analysis)"
            [attr.aria-label]="'View details for analysis from ' + formatDate(analysis.uploadDate)"
          >
            <!-- Date/Time Column -->
            <div class="table-cell date-column">
              <div class="date-info">
                <div class="primary-date">
                  {{ formatDateShort(analysis.uploadDate) }}
                </div>
                <div class="secondary-date">
                  {{ formatTimeShort(analysis.uploadDate) }}
                </div>
                <div *ngIf="analysis.patientInfo?.name" class="patient-name">
                  {{ analysis.patientInfo?.name }}
                </div>
              </div>
            </div>

            <!-- Severity Column -->
            <div class="table-cell severity-column">
              <div class="severity-info">
                <mat-chip
                  *ngIf="analysis.status === 'completed' && analysis.prediction"
                  [class]="getSeverityClass(analysis.prediction.severity_level)"
                  class="severity-chip"
                >
                  {{ getSeverityDisplayName(analysis.prediction.severity_level)
                  }}
                </mat-chip>

                <mat-chip
                  *ngIf="analysis.status !== 'completed'"
                  [class]="getStatusClass(analysis.status)"
                  class="status-chip"
                >
                  <mat-icon class="chip-icon"
                    >{{ getStatusIcon(analysis.status) }}</mat-icon
                  >
                  {{ analysis.status | titlecase }}
                </mat-chip>

                <div
                  *ngIf="analysis.status === 'completed' && analysis.prediction"
                  class="confidence-info"
                >
                  {{ getConfidencePercentage(analysis) }}% confidence
                </div>
              </div>
            </div>

            <!-- Retina Image Column -->
            <div class="table-cell image-column">
              <div class="image-container">
                <img
                  [src]="analysis.originalImageUrl"
                  [alt]="'Retinal scan for ' + (analysis.patientInfo?.name || 'patient')"
                  class="retinal-thumbnail"
                  loading="lazy"
                  (error)="onImageError($event)"
                />
                <div
                  class="image-overlay"
                  *ngIf="analysis.status === 'processing'"
                >
                  <mat-spinner diameter="20"></mat-spinner>
                </div>
              </div>
            </div>

            <!-- Actions Column -->
            <div class="table-cell actions-column">
              <div class="action-buttons" (click)="$event.stopPropagation()">
                <button
                  mat-stroked-button
                  color="primary"
                  class="view-btn"
                  (click)="viewAnalysisDetails(analysis)"
                >
                  View
                </button>

                <button
                  mat-icon-button
                  [matMenuTriggerFor]="actionMenu"
                  class="action-menu-btn"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #actionMenu="matMenu">
                  <button mat-menu-item (click)="viewAnalysisDetails(analysis)">
                    <mat-icon>visibility</mat-icon>
                    View Details
                  </button>
                  <button mat-menu-item (click)="downloadReport(analysis)">
                    <mat-icon>download</mat-icon>
                    Download Report
                  </button>
                  <mat-divider></mat-divider>
                  <button
                    mat-menu-item
                    (click)="deleteAnalysis(analysis.id, $event)"
                    class="delete-action"
                  >
                    <mat-icon color="warn">delete</mat-icon>
                    Delete
                  </button>
                </mat-menu>
              </div>
            </div>
          </button>
        </div>
      </div>

      <!-- Table Footer with Pagination Info -->
      <div class="table-footer">
        <div class="results-info">
          Showing {{ filteredAnalyses().length }} of {{ analyses().length }}
          results
        </div>
      </div>
    </div>

    <!-- No Search Results -->
    <div
      *ngIf="!isLoading() && !error() && analyses().length > 0 && filteredAnalyses().length === 0"
      class="no-results"
    >
      <mat-icon>search_off</mat-icon>
      <h3>No results found</h3>
      <p>
        Try adjusting your search criteria or
        <button mat-button (click)="clearSearch()">clear the search</button>
      </p>
    </div>
  </div>
</app-dashboard-layout>
